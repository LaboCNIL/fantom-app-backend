<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration>

<configuration scan="true">

   <springProperty name="logging_file_path" source="logging.file.path"/>
   <springProperty name="logging_level_root" source="logging.level.ROOT"/>
   <springProperty name="logging_level_sql" source="logging.level.sql" />
   
   <property name="ROOT_LEVEL" value="${logging_level_root}"/>
   <property name="LOG_FILE" value="${logging_file_path}"/>

   <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
   <include resource="org/springframework/boot/logging/logback/console-appender.xml"/>
   <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
      <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
         <fileNamePattern>${LOG_FILE}/fantome-app.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
         <!-- each archived file, size max 10MB -->
         <maxFileSize>10MB</maxFileSize>
         <!-- total size of all archive files, if total size > 20GB, it will delete old archived file -->
         <totalSizeCap>20GB</totalSizeCap>
         <!-- 60 days to keep -->
         <maxHistory>60</maxHistory>
      </rollingPolicy>

      <encoder>
         <pattern>${FILE_LOG_PATTERN}</pattern>
      </encoder>
   </appender>

   <root level="${ROOT_LEVEL}">
      <appender-ref ref="CONSOLE"/>
   </root>

   <!-- Par défaut, on ne log pas dans un fichier, ce comportement est modifiable grâce au profil spring `file-logging` -->
   <springProfile name="file-logging">
      <root level="${ROOT_LEVEL}">
         <appender-ref ref="FILE"/>
      </root>
   </springProfile>
   
   <logger name="sun.rmi" level="WARN"/>
   <logger name="com.zaxxer" level="WARN"/>
   <logger name="org.apache" level="WARN"/>
   <logger name="javax.activation" level="WARN"/>
   <logger name="javax.mail" level="WARN"/>
   <logger name="javax.management.remote" level="WARN"/>
   <logger name="javax.xml.bind" level="WARN"/>
   <logger name="ch.qos.logback" level="WARN"/>

   <logger name="org.ehcache" level="INFO"/>
   <logger name="org.hibernate.validator" level="WARN"/>
   <logger name="org.hibernate" level="INFO"/>
   <logger name="org.hibernate.SQL" level="${logging_level_sql}" />
   <!-- à partir de springboot v3 -->
   <logger name="org.hibernate.orm.jdbc.bind" level="${logging_level_sql}" />

   <logger name="org.postgresql" level="WARN"/>
   <logger name="org.springframework" level="INFO"/>
   <logger name="org.springframework.web" level="${ROOT_LEVEL}"/>
   <logger name="org.springframework.security" level="${ROOT_LEVEL}"/>
   <logger name="org.springframework.cache" level="INFO"/>

   <!-- https://logback.qos.ch/manual/configuration.html#shutdownHook and https://jira.qos.ch/browse/LOGBACK-1090 -->
   <shutdownHook class="ch.qos.logback.core.hook.DefaultShutdownHook"/>

   <contextListener class="ch.qos.logback.classic.jul.LevelChangePropagator">
      <resetJUL>true</resetJUL>
   </contextListener>

</configuration>
